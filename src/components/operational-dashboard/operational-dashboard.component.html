<div class="w-full">
    <h2 class="text-2xl font-semibold mb-6 text-gray-900 dark:text-white">{{ title() }}</h2>

    <!-- Tabs Navigation -->
    <div class="border-b border-gray-200 dark:border-gray-700 mb-4">
        <nav class="-mb-px flex space-x-2 overflow-x-auto" aria-label="Tabs">
             @for(pi of performanceIndicators(); track pi.id) {
                <button 
                    (click)="selectTab(pi.id)"
                    [class]="activeTab() === pi.id 
                        ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' 
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600'"
                    class="whitespace-nowrap py-4 px-3 border-b-2 font-medium text-sm transition-colors duration-200">
                PI {{ pi.id }}
                </button>
             }
        </nav>
    </div>

    <!-- Tab Content -->
    @if(activePIData(); as pi) {
        <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-lg font-bold mb-1 text-gray-900 dark:text-white">Performance Indicator #{{ pi.id }}</h3>
                    <div class="flex items-center gap-4">
                      <p class="text-md font-medium text-indigo-600 dark:text-indigo-400">{{ pi.title }}</p>
                    </div>
                </div>
                @if(canCreateActivity()) {
                    <button (click)="startCreate()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center space-x-2 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 64 64">
                            <path fill="#a0cff1" d="M4,10a6,6,0,0,1,6-6H54a6,6,0,0,1,6,6V50a6,6,0,0,1-6,6H10a6,6,0,0,1-6-6V10Z"></path>
                            <path fill="white" d="M4,20V50a6,6,0,0,0,6,6H54a6,6,0,0,0,6-6V20H4Z"></path>
                            <path fill="#a0cff1" d="M4,10a6,6,0,0,1,6-6H54a6,6,0,0,1,6,6V20H4V10Z"></path>
                            <rect x="20" y="8" width="24" height="6" fill="white" rx="2"></rect>
                            <circle cx="11" cy="12" r="3" fill="#2b6cb0"></circle>
                            <circle cx="18" cy="12" r="3" fill="#2b6cb0"></circle>
                            <rect x="16" y="26" width="8" height="20" fill="#4caf50" rx="2"></rect>
                            <rect x="28" y="34" width="8" height="12" fill="#ff9800" rx="2"></rect>
                            <rect x="40" y="30" width="8" height="16" fill="#2196f3" rx="2"></rect>
                            <circle cx="50" cy="50" r="12" fill="#4caf50" stroke="white" stroke-width="1"></circle>
                            <path d="M46 50 H54 M50 46 V54" stroke="white" stroke-width="3" stroke-linecap="round"></path>
                        </svg>
                        <span>Add Activity</span>
                    </button>
                }
            </div>


            <div class="overflow-x-auto">
                <table class="min-w-full border-collapse border border-slate-400 dark:border-slate-500">
                    <thead class="text-gray-800">
                        <tr class="bg-yellow-400">
                          <th scope="col" rowspan="2" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider align-middle border border-slate-300 dark:border-slate-600">Activities</th>
                          <th scope="col" rowspan="2" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider align-middle border border-slate-300 dark:border-slate-600">Performance Indicator</th>
                          <th scope="colgroup" colspan="13" class="px-2 py-3 text-center text-xs font-bold uppercase tracking-wider bg-cyan-400 border border-slate-300 dark:border-slate-600">2025 Accomplishment</th>
                           @if (canManage()) {
                            <th scope="col" rowspan="2" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider align-middle border border-slate-300 dark:border-slate-600">Actions</th>
                           }
                        </tr>
                        <tr class="bg-yellow-400">
                           @for(header of tableHeaders; track header) {
                              <th scope="col" class="px-2 py-3 text-center text-xs font-bold uppercase tracking-wider border border-slate-300 dark:border-slate-600">{{ header }}</th>
                           }
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800">
                         @for(activity of pi.activities; track activity.id) {
                           @if (editingActivity()?.id !== activity.id) {
                            <tr>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-200 border border-slate-300 dark:border-slate-600">{{ activity.name }}</td>
                                <td class="px-4 py-3 whitespace-normal text-sm text-gray-600 dark:text-gray-400 border border-slate-300 dark:border-slate-600">{{ activity.indicator }}</td>
                                @for(header of tableHeaders; track header) {
                                    <td class="px-2 py-3 whitespace-nowrap text-sm text-center text-gray-500 dark:text-gray-300 border border-slate-300 dark:border-slate-600">
                                      <div class="flex items-center justify-center gap-2">
                                        <span>{{ activity.accomplishments[header] }}</span>
                                        @if (canManage() && header !== 'Total' && activity.id) {
                                          @let fileKey = activity.id + '-' + header;
                                          <button (click)="openFileUploadModal(activity, header)" class="relative p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" [class.text-green-500]="uploadedFiles()[fileKey]?.length > 0" title="Manage Files">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                                              <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a3 3 0 006 0V7a3 3 0 00-3-3zM7 7a1 1 0 012 0v4a1 1 0 11-2 0V7z" clip-rule="evenodd" />
                                              <path d="M4 5a2 2 0 012-2h6a2 2 0 110 4H6a2 2 0 01-2-2z" />
                                            </svg>
                                          </button>
                                        }
                                      </div>
                                    </td>
                                }
                                @if(canManage()){
                                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium border border-slate-300 dark:border-slate-600">
                                      <div class="flex items-center justify-end space-x-2">
                                        <button (click)="startEdit(activity)" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-200" title="Edit Activity">
                                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"></path>
                                          </svg>
                                        </button>
                                        <button (click)="deleteActivity(activity)" class="p-1 rounded-full hover:opacity-80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 dark:focus:ring-offset-gray-900 focus:ring-red-500" title="Delete Activity">
                                          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none">
                                            <circle cx="12" cy="12" r="11" fill="#ef4444"></circle>
                                            <path stroke="#ffffff" stroke-linecap="round" stroke-width="2.5" d="M8.5 8.5l7 7m0-7l-7 7"></path>
                                          </svg>
                                        </button>
                                      </div>
                                  </td>
                                }
                            </tr>
                           } @else {
                            <tr [formGroup]="activityForm" class="bg-indigo-100 dark:bg-indigo-900/50">
                                <td class="p-1 border border-slate-300 dark:border-slate-600"><input formControlName="name" class="w-full bg-white dark:bg-gray-700 p-2 rounded-md border-gray-300 dark:border-gray-600 shadow-sm text-sm"></td>
                                <td class="p-1 border border-slate-300 dark:border-slate-600"><input formControlName="indicator" class="w-full bg-white dark:bg-gray-700 p-2 rounded-md border-gray-300 dark:border-gray-600 shadow-sm text-sm"></td>
                                <ng-container formGroupName="accomplishments">
                                  @for(header of tableHeaders.slice(0, 12); track header) {
                                      <td class="p-1 border border-slate-300 dark:border-slate-600">
                                        @if (isAccomplishmentNumeric(header)) {
                                          <input type="number" [formControlName]="header" class="w-20 bg-white dark:bg-gray-700 p-2 text-center rounded-md border-gray-300 dark:border-gray-600 shadow-sm text-sm">
                                        } @else {
                                          <div class="w-20 bg-gray-100 dark:bg-gray-700/50 p-2 text-center rounded-md text-sm text-gray-700 dark:text-gray-300">
                                            {{ activityForm.get('accomplishments')?.get(header)?.value }}
                                          </div>
                                        }
                                      </td>
                                  }
                                </ng-container>
                                <td class="p-1 border border-slate-300 dark:border-slate-600 text-center font-bold"></td> <!-- Total placeholder -->
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium border border-slate-300 dark:border-slate-600">
                                    <div class="flex items-center justify-end space-x-2">
                                      <button (click)="saveEdit()" [disabled]="activityForm.invalid" class="text-green-600 hover:text-green-900 disabled:opacity-50 disabled:cursor-not-allowed font-semibold">Save</button>
                                      <button (click)="cancelEdit()" class="p-1 rounded-full hover:opacity-80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 dark:focus:ring-offset-gray-900 focus:ring-red-500" title="Cancel Edit">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" viewBox="0 0 24 24" fill="none">
                                          <circle cx="12" cy="12" r="11" fill="#ef4444"></circle>
                                          <path stroke="#ffffff" stroke-linecap="round" stroke-width="2.5" d="M8.5 8.5l7 7m0-7l-7 7"></path>
                                        </svg>
                                      </button>
                                    </div>
                                </td>
                            </tr>
                           }
                        } @empty {
                            <tr>
                                <td [attr.colspan]="canManage() ? 16 : 15" class="text-center py-4 text-gray-500 dark:text-gray-400 border border-slate-300 dark:border-slate-600">No activities data available for this indicator.</td>
                            </tr>
                        }
                    </tbody>
                     @if (pi.total) {
                        <tfoot class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th scope="row" colspan="2" class="px-4 py-3 text-right text-sm font-bold text-gray-900 dark:text-white uppercase border border-slate-300 dark:border-slate-600">Total</th>
                                @for (header of tableHeaders; track header) {
                                  <td class="px-2 py-3 text-center text-sm font-bold text-gray-900 dark:text-white border border-slate-300 dark:border-slate-600">{{ pi.total[header] }}</td>
                                }
                                @if (canManage()) {
                                  <td class="border border-slate-300 dark:border-slate-600"></td>
                                }
                            </tr>
                        </tfoot>
                     }
                </table>
            </div>
        </div>
    } @else {
        <p class="text-center text-gray-500 dark:text-gray-400">Please select a Performance Indicator tab to view its data.</p>
    }
</div>

<!-- File Upload Modal -->
@if(isFileModalOpen() && selectedFileContext(); as context) {
  <div class="fixed inset-0 bg-black bg-opacity-60 z-40" (click)="closeFileModal()"></div>
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div (click)="$event.stopPropagation()" class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl transform transition-all duration-300 ease-in-out">
      <div class="p-6">
        <div class="flex justify-between items-center pb-3 border-b border-gray-200 dark:border-gray-700">
          <div>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Manage Files</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">{{ context.activity.name }} - {{ context.month }}</p>
          </div>
          <button (click)="closeFileModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>

        <div class="mt-4 space-y-4">
          <!-- File Upload Section -->
          <div>
            <label for="file-upload" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Upload New File</label>
            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-md">
              <div class="space-y-1 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                <div class="flex text-sm text-gray-600 dark:text-gray-400">
                  <label for="file-upload-input" class="relative cursor-pointer bg-white dark:bg-gray-700 rounded-md font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                    <span>Select files</span>
                    <input id="file-upload-input" name="file-upload" type="file" class="sr-only" (change)="handleFileUpload($event)" multiple>
                  </label>
                  <p class="pl-1">or drag and drop</p>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400">Any file type up to 10MB</p>
              </div>
            </div>
          </div>
          
          <!-- Uploaded Files List -->
          <div>
            <h4 class="text-lg font-medium text-gray-900 dark:text-white">Uploaded Files</h4>
            <div class="mt-2 border border-gray-200 dark:border-gray-700 rounded-lg max-h-60 overflow-y-auto">
              <ul class="divide-y divide-gray-200 dark:divide-gray-700">
                @for(file of currentFiles(); track file.name) {
                  <li class="pl-3 pr-4 py-3 flex items-center justify-between text-sm">
                    <div class="w-0 flex-1 flex items-center">
                      <svg class="flex-shrink-0 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a3 3 0 006 0V7a3 3 0 00-3-3zM7 7a1 1 0 012 0v4a1 1 0 11-2 0V7z" clip-rule="evenodd" /><path d="M4 5a2 2 0 012-2h6a2 2 0 110 4H6a2 2 0 01-2-2z" /></svg>
                      <span class="ml-2 flex-1 w-0 truncate text-gray-800 dark:text-gray-200">{{ file.name }}</span>
                    </div>
                    <div class="ml-4 flex-shrink-0 space-x-4">
                      <a [href]="file.dataUrl" target="_blank" class="font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">View</a>
                      <button (click)="deleteFile(file.name)" class="font-medium text-red-600 dark:text-red-400 hover:text-red-500">Delete</button>
                    </div>
                  </li>
                } @empty {
                  <li class="pl-3 pr-4 py-3 text-center text-sm text-gray-500 dark:text-gray-400">
                    No files uploaded yet.
                  </li>
                }
              </ul>
            </div>
          </div>
        </div>
        
        <div class="pt-4 flex justify-end items-center border-t border-gray-200 dark:border-gray-700 mt-4">
          <button (click)="closeFileModal()" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg transition duration-300">Close</button>
        </div>
      </div>
    </div>
  </div>
}